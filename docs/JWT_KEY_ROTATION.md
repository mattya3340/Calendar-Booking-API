# JWT キーローテーション機能

このドキュメントでは、JWTキーローテーション機能の仕組みと使用方法について説明します。

## 機能の概要

- 自動キーローテーション: 設定された期間（デフォルト30日）で自動的に署名キーが更新されます
- シームレスな移行: 古いキーで発行されたトークンは、キー有効期限までは引き続き有効です
- セキュアなキー生成: 強力な暗号学的乱数を使用してキーを生成します

## 設定方法

1. キー生成スクリプトを実行します:
   ```bash
   python scripts/generate_keys.py
   ```

2. 生成された管理者認証情報を安全な場所に保管してください

## 環境変数

| 変数名 | 説明 | デフォルト値 |
|--------|------|--------------|
| `SECRET_KEY` | JWTの署名に使用されるシークレットキー | 自動生成 |
| `ALGORITHM` | JWTの署名アルゴリズム | `HS256` |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | アクセストークンの有効期間（分） | `1440` (24時間) |
| `KEY_ROTATION_DAYS` | キーローテーション間隔（日） | `30` |

## クライアント側の実装

クライアントアプリケーションでは、以下の点に注意してください：

1. レスポンスの`key_expires_at`をチェックし、期限が近づいたら新しいトークンを取得してください
2. トークンリフレッシュは`/auth/refresh-token`エンドポイントを使用してください
3. 401エラーが返された場合は、再ログインを促してください

## トラブルシューティング

- キーローテーションが機能しない場合:
  - アプリケーションを再起動してください
  - サーバーの時刻が正しいことを確認してください

- トークンの検証に失敗する場合:
  - クライアントのシステム時刻が正しいことを確認してください
  - トークンの有効期限を確認してください

## セキュリティ上の注意

- 本番環境では必ず強力な`SECRET_KEY`を使用してください
- 定期的にキーをローテーションすることを推奨します
- 機密情報をトークンに含めないでください
